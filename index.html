<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DABBADOO: FINAL SIGMA - ENHANCED EDITION</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Black+Ops+One&display=swap');
        body { margin: 0; overflow: hidden; background: #000; touch-action: none; font-family: 'Black Ops One', system-ui; }
        
        /* Orientation Force */
        #lock { position: fixed; inset: 0; background: #000; color: #f00; z-index: 1000; display: none; align-items: center; justify-content: center; text-align: center; border: 10px solid #f00; animation: pulse 1.5s infinite; }
        @media (orientation: portrait) { #lock { display: flex; } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* HUD - Improved with Glow and Layout */
        #hud { position: absolute; top: 20px; left: 20px; z-index: 10; pointer-events: none; text-shadow: 0 0 10px #0f0; }
        .stat { color: #0f0; font-size: 26px; margin-bottom: 8px; letter-spacing: 1px; }
        #hp-bg { width: 250px; height: 18px; background: rgba(0,0,0,0.6); border: 3px solid #f00; border-radius: 8px; overflow: hidden; box-shadow: 0 0 15px #f00; }
        #hp-val { width: 100%; height: 100%; background: linear-gradient(to right, #f00, #ff8000); transition: width 0.3s ease; }

        #score { position: absolute; top: 20px; right: 20px; color: #ff0; font-size: 26px; text-shadow: 0 0 10px #ff0; z-index: 10; pointer-events: none; }

        /* Buttons - Polished with Glow and Better Sizing */
        .btn { position: absolute; z-index: 20; border-radius: 50%; border: 4px solid #fff; color: #fff; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.5); font-size: 16px; box-shadow: 0 0 20px rgba(255,255,255,0.4); transition: transform 0.1s; }
        .btn:active { transform: scale(1.1); }
        #jump-btn { bottom: 130px; right: 50px; width: 90px; height: 90px; background: #4400ff; box-shadow: 0 0 25px #4400ff; }
        #shoot-btn { bottom: 20px; right: 40px; width: 120px; height: 120px; background: #ff0044; border-color: #ff0; font-size: 22px; box-shadow: 0 0 25px #ff0044; animation: shootpulse 1.2s infinite; }
        @keyframes shootpulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* FIXED JOYSTICK - Smoother with Glow */
        #joy-base { position: absolute; bottom: 30px; left: 30px; width: 140px; height: 140px; background: rgba(255,255,255,0.1); border: 3px solid #0ff; border-radius: 50%; z-index: 20; box-shadow: 0 0 15px #0ff; }
        #joy-knob { position: absolute; top: 45px; left: 45px; width: 50px; height: 50px; background: #0ff; border-radius: 50%; box-shadow: 0 0 20px #0ff; }

        #win-screen { position: fixed; inset: 0; background: rgba(0,0,0,0.9); color: #0ff; display: none; align-items: center; justify-content: center; flex-direction: column; z-index: 500; font-size: 60px; text-shadow: 0 0 30px #0ff; animation: winGlow 1.5s infinite; }
        @keyframes winGlow { 0% { text-shadow: 0 0 30px #0ff; } 50% { text-shadow: 0 0 50px #0ff; } 100% { text-shadow: 0 0 30px #0ff; } }

        #game-over { position: fixed; inset: 0; background: rgba(0,0,0,0.9); color: #f00; display: none; align-items: center; justify-content: center; flex-direction: column; z-index: 500; font-size: 60px; text-shadow: 0 0 30px #f00; animation: loseGlow 1.5s infinite; }
        @keyframes loseGlow { 0% { text-shadow: 0 0 30px #f00; } 50% { text-shadow: 0 0 50px #f00; } 100% { text-shadow: 0 0 30px #f00; } }

        #cake-warning { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); color: #f00; font-size: 20px; opacity: 0.6; pointer-events: none; animation: flicker 2s infinite; }
        @keyframes flicker { 0%,100% { opacity: 0.6; } 50% { opacity: 0.3; } }
    </style>
</head>
<body>
    <div id="lock"><h1>ROTATE SCREEN BRO!<br>SIGMAS PLAY HORIZONTAL</h1></div>
    <div id="cake-warning">THE CAKE IS A LIE. THE CAKE IS A LIE.</div>

    <div id="hud">
        <div class="stat">VULVIAN LVL: <span id="vlvl">1</span></div>
        <div class="stat">KILLS: <span id="kills">0</span></div>
        <div id="hp-bg"><div id="hp-val"></div></div>
    </div>
    <div id="score">SCORE: <span id="score-val">0</span></div>

    <div id="joy-base"><div id="joy-knob"></div></div>
    <div id="jump-btn" class="btn">JUMP</div>
    <div id="shoot-btn" class="btn">SNOT</div>

    <div id="win-screen"><h1>THX BRO!</h1><p style="font-size: 30px;">VULVIAN LEVEL UP</p><p style="font-size: 24px;">SCORE: <span id="win-score">0</span></p></div>
    <div id="game-over"><h1>GRIND OVER!</h1><p style="font-size: 30px;">RETRY SIGMA</p><p style="font-size: 24px;">SCORE: <span id="lose-score">0</span></p></div>

    <script src="https://unpkg.com/three@0.155.0/build/three.min.js"></script>
    <script>
        /** DABBADOO: FINAL SIGMA - ENHANCED EDITION **/
        let scene, camera, renderer, clock, gun;
        let platforms = [], enemies = [], bullets = [], powerUps = [], snotParticles = [];
        let vLvl = 1, hp = 100, score = 0, kills = 0, ammo = 12, maxAmmo = 12, reloading = false;
        let jumps = 0, velY = 0, isPlaying = true;
        let move = { x: 0, y: 0 }, look = { x: 0, y: 0 };
        let touches = { move: null, look: null, lx: 0, ly: 0 };
        let boobi, cage;

        init();
        animate();

        function createStarBox() {
            const canvas = document.createElement('canvas');
            canvas.width = 512; canvas.height = 512;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#050010'; ctx.fillRect(0,0,512,512);
            for(let i=0; i<300; i++) { // More stars for better design
                ctx.fillStyle = '#fff';
                ctx.fillRect(Math.random()*512, Math.random()*512, 1 + Math.random()*2, 1 + Math.random()*2);
            }
            const tex = new THREE.CanvasTexture(canvas);
            tex.wrapS = tex.wrapT = THREE.RepeatWrapping;
            tex.repeat.set(6, 6);
            return tex;
        }

        function createFaceTexture(evil = false) {
            const canvas = document.createElement('canvas');
            canvas.width = 64; canvas.height = 64;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = 'white'; ctx.fillRect(0,0,64,64);
            ctx.fillStyle = 'black';
            // Eyes
            ctx.fillRect(15, 20, 8, 8); ctx.fillRect(40, 20, 8, 8);
            // Smirk
            ctx.beginPath();
            if(evil) { ctx.moveTo(15, 45); ctx.lineTo(50, 40); } 
            else { ctx.moveTo(15, 45); ctx.lineTo(50, 45); }
            ctx.lineWidth = 4; ctx.stroke();
            return new THREE.CanvasTexture(canvas);
        }

        function init() {
            scene = new THREE.Scene();
            clock = new THREE.Clock();
            
            camera = new THREE.PerspectiveCamera(85, window.innerWidth/window.innerHeight, 0.1, 1000); // Slightly wider FOV for better immersion

            renderer = new THREE.Web
