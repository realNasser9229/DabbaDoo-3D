<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DabbaDoo ULTRA</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; touch-action: none; font-family: 'Segoe UI', sans-serif; }
        #ui { position: absolute; top: 20px; left: 20px; color: #fff; z-index: 100; pointer-events: none; }
        .stat { font-size: 24px; font-weight: 900; text-shadow: 0 0 10px #0ff; letter-spacing: 2px; }
        
        #crosshair { position: absolute; top: 50%; left: 50%; width: 30px; height: 30px; border: 2px solid rgba(0,255,255,0.3); border-radius: 50%; transform: translate(-50%, -50%); z-index: 50; }
        #crosshair:after { content: ''; position: absolute; top: 50%; left: 50%; width: 4px; height: 4px; background: #0ff; border-radius: 50%; transform: translate(-50%, -50%); box-shadow: 0 0 10px #0ff; }

        /* UI Buttons */
        .btn { position: absolute; border-radius: 50%; background: rgba(0,0,0,0.5); border: 2px solid #0ff; display: flex; align-items: center; justify-content: center; color: #0ff; z-index: 100; backdrop-filter: blur(10px); transition: transform 0.1s; }
        .btn:active { transform: scale(0.9); }
        
        #joy-base { width: 120px; height: 120px; bottom: 40px; left: 40px; background: rgba(255,255,255,0.05); border: 1px solid rgba(0,255,255,0.2); border-radius: 50%; position: absolute; }
        #joy-knob { width: 60px; height: 60px; background: #0ff; opacity: 0.5; border-radius: 50%; position: absolute; top: 30px; left: 30px; box-shadow: 0 0 20px #0ff; }
        
        #jump-btn { width: 80px; height: 80px; bottom: 150px; right: 40px; font-weight: bold; }
        #shoot-btn { width: 120px; height: 120px; bottom: 20px; right: 30px; font-size: 20px; font-weight: 900; background: rgba(255,0,0,0.2); border-color: #f00; color: #f00; box-shadow: 0 0 30px rgba(255,0,0,0.3); }
        
        #reload-bar { position: absolute; bottom: 20%; left: 50%; transform: translateX(-50%); width: 200px; height: 4px; background: rgba(255,255,255,0.1); display: none; }
        #reload-progress { width: 0%; height: 100%; background: #0ff; }
    </style>
</head>
<body>
    <div id="ui">
        <div class="stat">SCORE: <span id="sc">0</span></div>
        <div class="stat">AMMO: <span id="am">8/8</span></div>
    </div>
    <div id="reload-bar"><div id="reload-progress"></div></div>
    <div id="crosshair"></div>
    <div id="joy-base"><div id="joy-knob"></div></div>
    <div id="jump-btn" class="btn">JUMP</div>
    <div id="shoot-btn" class="btn">FIRE</div>

    <script src="https://unpkg.com/three@0.155.0/build/three.min.js"></script>
    <script>
        let scene, camera, renderer, gun, flash, clock, shake = 0;
        let bullets = [], enemies = [], particles = [];
        let score = 0, ammo = 8, reloading = false;
        
        // NATURAL "EXVERTED" CONTROLS
        const SENSITIVITY = 0.4;
        let move = { f: 0, r: 0 }, look = { lon: 0, lat: 0 }, velY = 0, grounded = true;
        let tData = { lookId: null, moveId: null, lx: 0, ly: 0 };

        init();
        animate();

        function init() {
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x000000, 0.02);
            clock = new THREE.Clock();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            camera.position.set(0, 1.7, 10);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            document.body.appendChild(renderer.domElement);

            scene.add(new THREE.AmbientLight(0xffffff, 0.5));

            // MAP GENERATION
            for(let i=0; i<70; i++) {
                let h = 5 + Math.random() * 25;
                const b = new THREE.Mesh(new THREE.BoxGeometry(4, h, 4), new THREE.MeshStandardMaterial({ color: 0x0a0a0a }));
                b.position.set(Math.random()*160-80, h/2, Math.random()*160-80);
                scene.add(b);
                // Neon strips on buildings
                const line = new THREE.Mesh(new THREE.BoxGeometry(4.1, 1, 4.1), new THREE.MeshBasicMaterial({ color: 0x00ffff }));
                line.position.y = h/2 - Math.random()*h;
                b.add(line);
            }
            scene.add(new THREE.GridHelper(300, 60, 0x111111, 0x00ffff));

            // THE GUN (High Detail)
            gun = new THREE.Group();
            const gBody = new THREE.Mesh(new THREE.BoxGeometry(0.2, 0.25, 1), new THREE.MeshStandardMaterial({color: 0x111111}));
            const gSlide = new THREE.Mesh(new THREE.BoxGeometry(0.18, 0.1, 0.9), new THREE.MeshStandardMaterial({color: 0x222222}));
            gSlide.position.y = 0.1;
            flash = new THREE.PointLight(0x00ffff, 0, 15);
            flash.position.z = -0.8;
            gun.add(gBody, gSlide, flash);
            gun.position.set(0.45, -0.4, -0.8);
            camera.add(gun);
            scene.add(camera);

            for(let i=0; i<15; i++) spawnEnemy();
            setupTouch();
            window.onresize = () => { camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); };
        }

        function spawnEnemy() {
            const group = new THREE.Group();
            const core = new THREE.Mesh(new THREE.SphereGeometry(0.8, 8, 8), new THREE.MeshStandardMaterial({color: 0xff0055, emissive: 0xff0055, emissiveIntensity: 2}));
            const ring = new THREE.Mesh(new THREE.TorusGeometry(1.2, 0.05, 8, 30), new THREE.MeshBasicMaterial({color: 0x00ffff}));
            group.add(core, ring);
            group.position.set(Math.random()*100-50, 2 + Math.random()*3, Math.random()*-100);
            scene.add(group); enemies.push(group);
        }

        function explode(pos) {
            for(let i=0; i<12; i++){
                const p = new THREE.Mesh(new THREE.BoxGeometry(0.2,0.2,0.2), new THREE.MeshBasicMaterial({color: 0x00ffff}));
                p.position.copy(pos);
                p.userData.v = new THREE.Vector3((Math.random()-0.5)*0.4, Math.random()*0.4, (Math.random()-0.5)*0.4);
                p.userData.life = 1.0;
                scene.add(p); particles.push(p);
            }
        }

        function setupTouch() {
            const joy = document.getElementById('joy-base'), knob = document.getElementById('joy-knob');
            window.ontouchstart = e => {
                for(let t of e.changedTouches) {
                    if (t.clientX > window.innerWidth/2) { tData.lookId = t.identifier; tData.lx = t.clientX; tData.ly = t.clientY; }
                    let r = joy.getBoundingClientRect();
                    if (t.clientX > r.left && t.clientX < r.right && t.clientY > r.top && t.clientY < r.bottom) tData.moveId = t.identifier;
                }
            };
            window.ontouchmove = e => {
                for(let t of e.changedTouches) {
                    if (t.identifier === tData.lookId) {
                        // EXVERTED: Normal Swipe Logic
                        look.lon -= (t.clientX - tData.lx) * SENSITIVITY;
                        look.lat -= (t.clientY - tData.ly) * SENSITIVITY;
                        tData.lx = t.clientX; tData.ly = t.clientY;
                    }
                    if (t.identifier === tData.moveId) {
                        let r = joy.getBoundingClientRect(), dx = t.clientX-(r.left+60), dy = t.clientY-(r.top+60);
                        let d = Math.min(Math.sqrt(dx*dx+dy*dy), 60), a = Math.atan2(dy, dx);
                        knob.style.transform = `translate(${Math.cos(a)*d}px, ${Math.sin(a)*d}px)`;
                        move.f = -Math.sin(a)*(d/60); move.r = Math.cos(a)*(d/60);
                    }
                }
            };
            window.ontouchend = e => {
                for(let t of e.changedTouches) {
                    if (t.identifier === tData.lookId) tData.lookId = null;
                    if (t.identifier === tData.moveId) { tData.moveId = null; move.f = 0; move.r = 0; knob.style.transform = `translate(0,0)`; }
                }
            };
            document.getElementById('shoot-btn').ontouchstart = e => { e.preventDefault(); shoot(); };
            document.getElementById('jump-btn').ontouchstart = e => { e.preventDefault(); if(grounded) { velY = 0.28; grounded = false; } };
        }

        function shoot() {
            if (reloading || ammo <= 0) { if(ammo <= 0) doReload(); return; }
            ammo--; document.getElementById('am').innerText = ammo + "/8";
            const b = new THREE.Mesh(new THREE.SphereGeometry(0.15), new THREE.MeshBasicMaterial({color: 0x00ffff}));
            b.position.copy(camera.position);
            const dir = new THREE.Vector3(0,0,-1).applyQuaternion(camera.quaternion);
            b.userData.v = dir.multiplyScalar(2.5);
            scene.add(b); bullets.push(b);
            flash.intensity = 25; gun.children[1].position.z = 0.2; // Slide blowback
            shake = 0.1; // Cam shake
            setTimeout(() => { flash.intensity = 0; gun.children[1].position.z = 0; }, 50);
            if(ammo === 0) doReload();
        }

        function doReload() {
            if(reloading) return; reloading = true;
            document.getElementById('reload-bar').style.display = 'block';
            let p = 0;
            let iv = setInterval(() => { p += 2; document.getElementById('reload-progress').style.width = p + '%'; if(p>=100) clearInterval(iv); }, 20);
            setTimeout(() => { ammo = 8; reloading = false; document.getElementById('am').innerText = "8/8"; document.getElementById('reload-bar').style.display = 'none'; }, 1000);
        }

        function animate() {
            requestAnimationFrame(animate);
            const t = performance.now() * 0.005;
            look.lat = Math.max(-85, Math.min(85, look.lat));
            camera.rotation.order = 'YXZ';
            camera.rotation.y = THREE.MathUtils.degToRad(look.lon);
            camera.rotation.x = THREE.MathUtils.degToRad(look.lat);

            // Screen Shake Decay
            if(shake > 0) { camera.position.x += (Math.random()-0.5)*shake; camera.position.y += (Math.random()-0.5)*shake; shake *= 0.8; }

            if(move.f || move.r) {
                camera.translateZ(-move.f * 0.25); camera.translateX(move.r * 0.25);
                gun.position.y = -0.4 + Math.sin(t*10)*0.02; // Walk bob
                gun.rotation.z = Math.sin(t*5)*0.05;
            }
            camera.position.y += velY;
            if(camera.position.y > 1.7) velY -= 0.015; else { camera.position.y = 1.7; velY = 0; grounded = true; }

            particles.forEach((p, i) => { p.position.add(p.userData.v); p.userData.life -= 0.02; p.scale.setScalar(p.userData.life); if(p.userData.life <= 0) { scene.remove(p); particles.splice(i,1); } });
            enemies.forEach(e => { e.position.y += Math.sin(t*2 + e.position.x)*0.03; e.rotation.y += 0.05; });

            for(let i=bullets.length-1; i>=0; i--) {
                bullets[i].position.add(bullets[i].userData.v);
                enemies.forEach((e, j) => {
                    if(bullets[i] && bullets[i].position.distanceTo(e.position) < 2) {
                        explode(e.position); scene.remove(e); enemies.splice(j, 1); scene.remove(bullets[i]); bullets.splice(i,1);
                        score++; document.getElementById('sc').innerText = score; spawnEnemy();
                    }
                });
                if(bullets[i] && bullets[i].position.length() > 300) { scene.remove(bullets[i]); bullets.splice(i,1); }
            }
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
