<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DABBADOO: RESCUE MISSION</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; touch-action: none; font-family: 'Comic Sans MS', sans-serif; }
        #ui { position: absolute; top: 10px; left: 10px; color: #fff; z-index: 100; pointer-events: none; width: 95%; }
        .stat-row { display: flex; justify-content: space-between; width: 100%; }
        .stat { font-size: 20px; font-weight: 900; text-shadow: 2px 2px #f00; color: #0f0; }
        
        /* Crosshair Fix */
        #crosshair { position: absolute; top: 50%; left: 50%; width: 30px; height: 30px; transform: translate(-50%, -50%); z-index: 50; pointer-events: none; }
        .ch-line { position: absolute; background: #0f0; box-shadow: 0 0 5px #0f0; transition: transform 0.1s; }
        #ch-top { width: 2px; height: 10px; left: 14px; top: 0; }
        #ch-bot { width: 2px; height: 10px; left: 14px; bottom: 0; }
        #ch-left { height: 2px; width: 10px; top: 14px; left: 0; }
        #ch-right { height: 2px; width: 10px; top: 14px; right: 0; }
        .recoil { transform: scale(1.5); }

        /* Buttons */
        .btn { position: absolute; border-radius: 15px; background: rgba(0,0,0,0.6); border: 3px solid #fff; display: flex; align-items: center; justify-content: center; color: #fff; z-index: 100; text-align: center; font-weight: bold; }
        #joy-base { width: 120px; height: 120px; bottom: 30px; left: 30px; background: rgba(255,255,255,0.1); border-radius: 50%; position: absolute; border: 1px solid #0ff; }
        #joy-knob { width: 50px; height: 50px; background: #0ff; border-radius: 50%; position: absolute; top: 35px; left: 35px; }
        
        #jump-btn { width: 80px; height: 80px; bottom: 140px; right: 30px; background: #f0f; font-size: 14px; }
        #shoot-btn { width: 110px; height: 110px; bottom: 20px; right: 20px; font-size: 22px; background: #f00; color: #ff0; border-color: #ff0; box-shadow: 0 0 20px #f00; }
        
        #msg-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #fff; font-size: 40px; font-weight: 900; text-align: center; display: none; z-index: 200; text-shadow: 4px 4px #f00; width: 80%; }
        #hp-bar { width: 200px; height: 20px; background: #300; border: 2px solid #fff; margin-top: 5px; }
        #hp-fill { width: 100%; height: 100%; background: #f00; transition: width 0.3s; }
    </style>
</head>
<body>
    <div id="ui">
        <div class="stat-row">
            <div class="stat">LEVEL: <span id="lvl">1</span></div>
            <div class="stat">AMMO: <span id="am">15/15</span></div>
        </div>
        <div class="stat">VULVIAN HP</div>
        <div id="hp-bar"><div id="hp-fill"></div></div>
    </div>
    
    <div id="msg-overlay">LEVEL CLEAR!</div>
    
    <div id="crosshair">
        <div id="ch-top" class="ch-line"></div>
        <div id="ch-bot" class="ch-line"></div>
        <div id="ch-left" class="ch-line"></div>
        <div id="ch-right" class="ch-line"></div>
    </div>

    <div id="joy-base"><div id="joy-knob"></div></div>
    <div id="jump-btn" class="btn">ALPHA<br>JUMP</div>
    <div id="shoot-btn" class="btn">GRIND</div>

    <script src="https://unpkg.com/three@0.155.0/build/three.min.js"></script>
    <script>
        // --- GAME STATE ---
        let scene, camera, renderer, gun, clock;
        let bullets = [], enemies = [], particles = [], platforms = [];
        let score = 0, ammo = 15, hp = 100, level = 1, reloading = false, jumps = 0;
        let boobiDoodi, cage, targetGoal;
        
        const SENSITIVITY = 0.4;
        let move = { f: 0, r: 0 }, look = { lon: 0, lat: 0 }, velY = 0;
        let tData = { lookId: null, moveId: null, lx: 0, ly: 0 };

        init();
        animate();

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a0015);
            scene.fog = new THREE.FogExp2(0x0a0015, 0.04);
            clock = new THREE.Clock();
            
            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            const ambient = new THREE.AmbientLight(0xffffff, 0.6);
            const sun = new THREE.PointLight(0x00ffff, 1, 100);
            sun.position.set(10, 20, 10);
            scene.add(ambient, sun);

            createVulvianHands();
            setupLevel(level);
            setupTouch();
            
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth/window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }

        function createVulvianHands() {
            gun = new THREE.Group();
            const arm = new THREE.Mesh(new THREE.BoxGeometry(0.2, 0.2, 0.8), new THREE.MeshStandardMaterial({color: 0xffffff}));
            arm.position.set(0.4, -0.4, -0.4);
            
            const weaponBody = new THREE.Mesh(new THREE.BoxGeometry(0.15, 0.25, 1), new THREE.MeshStandardMaterial({color: 0x111111}));
            weaponBody.position.set(0.4, -0.3, -0.8);
            
            const muzzle = new THREE.Mesh(new THREE.CylinderGeometry(0.05, 0.05, 0.2), new THREE.MeshStandardMaterial({color: 0x333333}));
            muzzle.rotation.x = Math.PI/2;
            muzzle.position.set(0.4, -0.3, -1.3);

            gun.add(arm, weaponBody, muzzle);
            camera.add(gun);
            scene.add(camera);
        }

        function setupLevel(lvl) {
            // Clear old level
            enemies.forEach(e => scene.remove(e));
            platforms.forEach(p => scene.remove(p));
            if(cage) scene.remove(cage);
            if(boobiDoodi) scene.remove(boobiDoodi);
            enemies = []; platforms = []; bullets = [];

            camera.position.set(0, 2, 0);
            look.lon = 0; look.lat = 0;

            // Spawn Start Platform
            createPlatform(0, 0, 0, 10, 10);

            // Level Logic: Parkour Path
            for(let i=1; i<=10; i++) {
                let pZ = -i * 12;
                let pX = Math.sin(i) * 5;
                let pY = i * 1.5;
                createPlatform(pX, pY, pZ, 6, 6);
                
                // Spawn Boobastas on platforms
                if(i % 2 === 0) spawnBoobasta(pX, pY + 2, pZ);
            }

            // Final Platform with Cage
            let finalZ = -140;
            let finalY = 18;
            createPlatform(0, finalY, finalZ, 15, 15, 0xff0000);
            spawnCage(0, finalY + 1, finalZ);
            
            document.getElementById('lvl').innerText = lvl;
        }

        function createPlatform(x, y, z, w, d, col = 0x00ffcc) {
            const geo = new THREE.BoxGeometry(w, 1, d);
            const mat = new THREE.MeshStandardMaterial({color: col, emissive: col, emissiveIntensity: 0.2});
            const plat = new THREE.Mesh(geo, mat);
            plat.position.set(x, y, z);
            scene.add(plat);
            platforms.push(plat);
        }

        function spawnBoobasta(x, y, z) {
            const group = new THREE.Group();
            const body = new THREE.Mesh(new THREE.BoxGeometry(1, 1.5, 0.5), new THREE.MeshStandardMaterial({color: 0x888888}));
            const head = new THREE.Mesh(new THREE.BoxGeometry(0.8, 0.8, 0.8), new THREE.MeshStandardMaterial({color: 0xcccccc}));
            head.position.y = 1.2;
            group.add(body, head);
            group.position.set(x, y, z);
            group.userData = { hp: 2, state: 'idle' };
            scene.add(group);
            enemies.push(group);
        }

        function spawnCage(x, y, z) {
            cage = new THREE.Group();
            const bars = new THREE.Mesh(new THREE.BoxGeometry(3, 4, 3), new THREE.MeshStandardMaterial({color: 0x444444, wireframe: true}));
            cage.add(bars);
            
            boobiDoodi = new THREE.Group();
            const body = new THREE.Mesh(new THREE.BoxGeometry(0.6, 1, 0.4), new THREE.MeshStandardMaterial({color: 0xff0000}));
            const head = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.5, 0.5), new THREE.MeshStandardMaterial({color: 0xffccaa}));
            head.position.y = 0.8;
            boobiDoodi.add(body, head);
            
            cage.position.set(x, y+1.5, z);
            boobiDoodi.position.copy(cage.position);
            scene.add(cage, boobiDoodi);
            targetGoal = cage.position;
        }

        function setupTouch() {
            const joy = document.getElementById('joy-base'), knob = document.getElementById('joy-knob');
            window.ontouchstart = e => {
                for(let t of e.changedTouches) {
                    if (t.clientX > window.innerWidth/2) { tData.lookId = t.identifier; tData.lx = t.clientX; tData.ly = t.clientY; }
                    let r = joy.getBoundingClientRect();
                    if (t.clientX > r.left && t.clientX < r.right && t.clientY > r.top && t.clientY < r.bottom) tData.moveId = t.identifier;
                }
            };
            window.ontouchmove = e => {
                for(let t of e.changedTouches) {
                    if (t.identifier === tData.lookId) {
                        look.lon -= (t.clientX - tData.lx) * SENSITIVITY;
                        look.lat -= (t.clientY - tData.ly) * SENSITIVITY;
                        tData.lx = t.clientX; tData.ly = t.clientY;
                    }
                    if (t.identifier === tData.moveId) {
                        let r = joy.getBoundingClientRect(), dx = t.clientX-(r.left+60), dy = t.clientY-(r.top+60);
                        let d = Math.min(Math.sqrt(dx*dx+dy*dy), 50), a = Math.atan2(dy, dx);
                        knob.style.transform = `translate(${Math.cos(a)*d}px, ${Math.sin(a)*d}px)`;
                        move.f = -Math.sin(a)*(d/50); move.r = Math.cos(a)*(d/50);
                    }
                }
            };
            window.ontouchend = e => {
                for(let t of e.changedTouches) {
                    if (t.identifier === tData.lookId) tData.lookId = null;
                    if (t.identifier === tData.moveId) { tData.moveId = null; move.f = 0; move.r = 0; knob.style.transform = `translate(0,0)`; }
                }
            };
            document.getElementById('shoot-btn').ontouchstart = e => { e.preventDefault(); shoot(); };
            document.getElementById('jump-btn').ontouchstart = e => { e.preventDefault(); if(jumps < 2) { velY = 0.28; jumps++; } };
        }

        function shoot() {
            if (reloading || ammo <= 0) { if(ammo <= 0) doReload(); return; }
            ammo--; document.getElementById('am').innerText = ammo + "/15";
            
            // Recoil Animation
            document.querySelectorAll('.ch-line').forEach(l => l.classList.add('recoil'));
            gun.position.z = 0.2;
            setTimeout(() => {
                document.querySelectorAll('.ch-line').forEach(l => l.classList.remove('recoil'));
                gun.position.z = 0;
            }, 100);

            const b = new THREE.Mesh(new THREE.SphereGeometry(0.1), new THREE.MeshBasicMaterial({color: 0xffff00}));
            b.position.copy(camera.position);
            const dir = new THREE.Vector3(0,0,-1).applyQuaternion(camera.quaternion);
            b.userData.v = dir.multiplyScalar(2);
            scene.add(b); bullets.push(b);
        }

        function doReload() {
            reloading = true;
            document.getElementById('am').innerText = "SNEEZING...";
            setTimeout(() => {
                ammo = 15; reloading = false;
                document.getElementById('am').innerText = "15/15";
            }, 1500);
        }

        function animate() {
            requestAnimationFrame(animate);
            const delta = clock.getDelta();
            const time = performance.now() * 0.001;

            // Rotation
            look.lat = Math.max(-85, Math.min(85, look.lat));
            camera.rotation.order = 'YXZ';
            camera.rotation.y = THREE.MathUtils.degToRad(look.lon);
            camera.rotation.x = THREE.MathUtils.degToRad(look.lat);

            // Movement
            let moveDir = new THREE.Vector3(move.r, 0, -move.f).applyQuaternion(new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0,1,0), camera.rotation.y));
            camera.position.add(moveDir.multiplyScalar(0.2));

            // Gravity & Collision
            velY -= 0.015;
            camera.position.y += velY;
            
            let onPlatform = false;
            platforms.forEach(p => {
                if (Math.abs(camera.position.x - p.position.x) < 3.5 && 
                    Math.abs(camera.position.z - p.position.z) < 3.5 && 
                    camera.position.y > p.position.y + 1.5 && camera.position.y < p.position.y + 2.5) {
                    camera.position.y = p.position.y + 1.7;
                    velY = 0; jumps = 0;
                    onPlatform = true;
                }
            });

            if (camera.position.y < -20) { // Fell off
                hp -= 20;
                camera.position.set(0, 5, 0);
                velY = 0;
                updateHP();
            }

            // AI Behavior (Boobastas chase player)
            enemies.forEach(e => {
                let dist = e.position.distanceTo(camera.position);
                if(dist < 15) {
                    e.lookAt(camera.position.x, e.position.y, camera.position.z);
                    let dir = new THREE.Vector3().subVectors(camera.position, e.position).normalize();
                    e.position.add(dir.multiplyScalar(0.05));
                    
                    if(dist < 2) { // Damage Vulvian
                        hp -= 0.5;
                        updateHP();
                    }
                }
            });

            // Bullets
            for(let i=bullets.length-1; i>=0; i--) {
                bullets[i].position.add(bullets[i].userData.v);
                enemies.forEach((e, j) => {
                    if(bullets[i] && bullets[i].position.distanceTo(e.position) < 1.5) {
                        scene.remove(e); enemies.splice(j, 1);
                        scene.remove(bullets[i]); bullets.splice(i,1);
                    }
                });
                if(bullets[i] && bullets[i].position.length() > 200) { scene.remove(bullets[i]); bullets.splice(i,1); }
            }

            // Check Win Condition (Reach Boobi Doodi)
            if(camera.position.distanceTo(targetGoal) < 3) {
                victory();
            }

            // Earthquake effect (RagorGaming style)
            camera.position.x += Math.sin(time * 50) * 0.01;

            renderer.render(scene, camera);
        }

        function updateHP() {
            document.getElementById('hp-fill').style.width = hp + "%";
            if(hp <= 0) location.reload(); // Rage quit / Restart
        }

        function victory() {
            const over = document.getElementById('msg-overlay');
            over.style.display = 'block';
            over.innerText = "THX BRO. DAB!";
            setTimeout(() => {
                over.style.display = 'none';
                level++;
                setupLevel(level);
            }, 3000);
            targetGoal = new THREE.Vector3(999,999,999); // Reset target
        }
    </script>
</body>
</html>
