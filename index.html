<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DABBADOO: OMEGA UPDATE</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Black+Ops+One&display=swap');
        body { margin: 0; overflow: hidden; background: #000; touch-action: none; font-family: 'Black Ops One', system-ui; user-select: none; -webkit-user-select: none; }
        
        /* UI OVERLAY */
        #crosshair { position: fixed; top: 50%; left: 50%; width: 10px; height: 10px; background: #0f0; border: 2px solid #000; transform: translate(-50%, -50%); border-radius: 50%; z-index: 50; box-shadow: 0 0 10px #0f0; pointer-events: none; }
        
        /* Orientation Force */
        #lock { position: fixed; inset: 0; background: #000; color: #f00; z-index: 1000; display: none; align-items: center; justify-content: center; text-align: center; border: 10px solid #f00; }
        @media (orientation: portrait) { #lock { display: flex; } }

        /* HUD */
        #hud { position: absolute; top: 20px; left: 20px; z-index: 10; pointer-events: none; }
        .stat { color: #0ff; font-size: 24px; text-shadow: 2px 2px #000; margin-bottom: 5px; font-style: italic; }
        #hp-bg { width: 250px; height: 15px; background: rgba(0,0,0,0.8); border: 2px solid #fff; transform: skewX(-20deg); overflow: hidden; }
        #hp-val { width: 100%; height: 100%; background: linear-gradient(90deg, #f00, #ff0); transition: 0.2s; }

        /* CONTROLS */
        .btn { position: absolute; z-index: 20; border-radius: 50%; border: 4px solid #fff; color: #fff; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.4); font-size: 14px; box-shadow: 0 0 15px rgba(255,255,255,0.2); }
        .btn:active { background: rgba(255,255,255,0.3); transform: scale(0.95); }
        
        #jump-btn { bottom: 130px; right: 40px; width: 90px; height: 90px; background: rgba(0, 89, 255, 0.4); }
        #shoot-btn { bottom: 30px; right: 30px; width: 120px; height: 120px; background: rgba(255, 0, 68, 0.4); border-color: #ff0; font-size: 20px; }

        /* JOYSTICK */
        #joy-base { position: absolute; bottom: 40px; left: 40px; width: 140px; height: 140px; background: rgba(255,255,255,0.05); border: 2px dashed #0ff; border-radius: 50%; z-index: 20; }
        #joy-knob { position: absolute; top: 45px; left: 45px; width: 50px; height: 50px; background: #0ff; border-radius: 50%; box-shadow: 0 0 20px #0ff; opacity: 0.8; }

        /* SCREENS */
        #win-screen, #start-screen { position: fixed; inset: 0; background: rgba(0,0,0,0.9); color: #fff; display: flex; align-items: center; justify-content: center; flex-direction: column; z-index: 500; text-align: center; }
        #start-screen { z-index: 600; display: flex; }
        #win-screen { display: none; }
        h1 { font-size: 60px; margin: 0; color: #0f0; text-shadow: 0 0 30px #0f0; }
        p { font-size: 24px; color: #fff; }
        .tap-msg { margin-top: 30px; animation: blink 1s infinite; color: #ff0; }
        @keyframes blink { 50% { opacity: 0; } }
    </style>
</head>
<body>
    <div id="lock"><h1>ROTATE SCREEN<br>TO PLAY</h1></div>
    <div id="crosshair"></div>
    
    <div id="start-screen">
        <h1>DABBADOO</h1>
        <p style="color:#0ff">FINAL SIGMA EDITION</p>
        <div class="tap-msg">TAP TO START GRIND</div>
    </div>

    <div id="win-screen"><h1>W</h1><p style="font-size: 20px;">VULVIAN LEVEL UP</p></div>

    <div id="hud">
        <div class="stat">SIGMA LVL: <span id="vlvl">1</span></div>
        <div id="hp-bg"><div id="hp-val"></div></div>
    </div>

    <div id="joy-base"><div id="joy-knob"></div></div>
    <div id="jump-btn" class="btn">JUMP</div>
    <div id="shoot-btn" class="btn">SNOT</div>

    <script src="https://unpkg.com/three@0.155.0/build/three.min.js"></script>
    <script>
        /** --- AUDIO ENGINE (SYNTHESIZER) --- **/
        const AudioSys = {
            ctx: null,
            init: function() {
                window.AudioContext = window.AudioContext || window.webkitAudioContext;
                this.ctx = new AudioContext();
            },
            playTone: function(freq, type, dur, vol = 0.1) {
                if(!this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                gain.gain.setValueAtTime(vol, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + dur);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                osc.stop(this.ctx.currentTime + dur);
            },
            shoot: function() { 
                if(!this.ctx) return;
                // Laser Pew
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.frequency.setValueAtTime(600, this.ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(100, this.ctx.currentTime + 0.15);
                gain.gain.setValueAtTime(0.1, this.ctx.currentTime);
                gain.gain.linearRampToValueAtTime(0, this.ctx.currentTime + 0.15);
                osc.connect(gain); gain.connect(this.ctx.destination);
                osc.start(); osc.stop(this.ctx.currentTime + 0.2);
            },
            jump: function() { this.playTone(150, 'triangle', 0.3, 0.2); },
            boom: function() { 
                // Noise burst approximation
                this.playTone(100, 'sawtooth', 0.2, 0.3);
                this.playTone(50, 'square', 0.3, 0.3);
            },
            win: function() {
                setTimeout(() => this.playTone(400, 'sine', 0.2), 0);
                setTimeout(() => this.playTone(600, 'sine', 0.2), 150);
                setTimeout(() => this.playTone(800, 'square', 0.4), 300);
            }
        };

        /** --- GAME ENGINE --- **/
        let scene, camera, renderer, clock, gun, muzzleLight;
        let platforms = [], enemies = [], bullets = [], particles = [];
        let vLvl = 1, hp = 100, isPlaying = false, jumps = 0, velY = 0;
        let move = { x: 0, y: 0 }, look = { x: 0, y: 0 };
        let touches = { move: null, look: null, lx: 0, ly: 0 };
        let cage, boobi;
        
        // Weapon State
        let gunRecoil = 0;
        let lastShot = 0;

        // Init on Tap
        document.getElementById('start-screen').addEventListener('click', () => {
            document.getElementById('start-screen').style.display = 'none';
            AudioSys.init();
            init();
            animate();
        });

        function createStarBox() {
            const canvas = document.createElement('canvas');
            canvas.width = 512; canvas.height = 512;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#020008'; ctx.fillRect(0,0,512,512);
            for(let i=0; i<300; i++) {
                ctx.fillStyle = Math.random() > 0.9 ? '#00ffff' : '#ffffff';
                let s = Math.random() * 2;
                ctx.fillRect(Math.random()*512, Math.random()*512, s, s);
            }
            const tex = new THREE.CanvasTexture(canvas);
            tex.wrapS = tex.wrapT = THREE.RepeatWrapping; tex.repeat.set(4, 4);
            return tex;
        }

        function init() {
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x050010, 0.015);
            clock = new THREE.Clock();
            
            camera = new THREE.PerspectiveCamera(90, window.innerWidth/window.innerHeight, 0.1, 1000);
            
            renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: "high-performance" });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            document.body.appendChild(renderer.domElement);

            // ENV
            const skyGeo = new THREE.SphereGeometry(500, 32, 32);
            const skyMat = new THREE.MeshBasicMaterial({ map: createStarBox(), side: THREE.BackSide });
            scene.add(new THREE.Mesh(skyGeo, skyMat));

            const ambient = new THREE.AmbientLight(0xffffff, 0.6);
            const sun = new THREE.DirectionalLight(0xff00ff, 0.8);
            sun.position.set(10, 20, 10);
            scene.add(ambient, sun);

            // COOLER GUN
            gun = new THREE.Group();
            const matGun = new THREE.MeshStandardMaterial({color: 0x333333, roughness: 0.2});
            const matGlow = new THREE.MeshBasicMaterial({color: 0x00ff00});
            
            const gBody = new THREE.Mesh(new THREE.BoxGeometry(0.25, 0.3, 0.8), matGun);
            const gBarrel = new THREE.Mesh(new THREE.CylinderGeometry(0.08, 0.08, 0.6, 8), matGun);
            gBarrel.rotation.x = Math.PI/2; gBarrel.position.z = -0.4; gBarrel.position.y = 0.1;
            const gSight = new THREE.Mesh(new THREE.BoxGeometry(0.05, 0.1, 0.1), matGlow);
            gSight.position.set(0, 0.2, 0.2);
            
            // Muzzle Flash Light
            muzzleLight = new THREE.PointLight(0x00ff00, 0, 5);
            muzzleLight.position.set(0, 0.1, -1);
            gun.add(muzzleLight);

            gun.add(gBody, gBarrel, gSight);
            gun.position.set(0.5, -0.4, -0.6);
            camera.add(gun);
            scene.add(camera);

            generateLevel();
            setupControls();
            window.addEventListener('resize', onResize);
        }

        function createExplosion(pos, color) {
            AudioSys.boom();
            for(let i=0; i<12; i++) {
                const geo = new THREE.BoxGeometry(0.3, 0.3, 0.3);
                const mat = new THREE.MeshBasicMaterial({color: color});
                const p = new THREE.Mesh(geo, mat);
                p.position.copy(pos);
                p.userData = {
                    vel: new THREE.Vector3((Math.random()-0.5), (Math.random()-0.5)+0.5, (Math.random()-0.5)).normalize().multiplyScalar(0.4),
                    life: 1.0
                };
                scene.add(p);
                particles.push(p);
            }
        }

        function generateLevel() {
            platforms.forEach(p => scene.remove(p));
            enemies.forEach(e => scene.remove(e));
            if(cage) scene.remove(cage);
            if(boobi) scene.remove(boobi);
            
            platforms = []; enemies = []; bullets = [];
            
            camera.position.set(0, 8, 0);
            isPlaying = true;
            hp = 100; updateHUD();

            // Materials
            const matFloor = new THREE.MeshStandardMaterial({color: 0x222222, roughness: 0.1});
            const matNeon = new THREE.MeshStandardMaterial({color: 0x001133, emissive: 0x0044ff, emissiveIntensity: 0.5});

            // Start Pad
            addBlock(0, 0, 0, 15, 15, matFloor);

            let z = -15, y = 0;
            const count = 6 + (vLvl * 2);

            for(let i=0; i<count; i++) {
                let x = (Math.random()-0.5) * 15;
                y += (Math.random()-0.3) * 4;
                z -= (12 + Math.random() * 5);
                
                // Platforms
                addBlock(x, y, z, 8, 8, matNeon);
                
                // Enemies
                if(i > 0) spawnMob(x, y+3, z);
            }

            // Goal
            z -= 20;
            addBlock(0, y, z, 15, 15, new THREE.MeshStandardMaterial({color: 0x440022, emissive: 0xff0055, emissiveIntensity: 0.4}));
            spawnRescue(0, y+3, z);
        }

        function addBlock(x, y, z, w, d, mat) {
            const b = new THREE.Mesh(new THREE.BoxGeometry(w, 2, d), mat);
            b.position.set(x, y, z);
            b.userData.bounds = { xMin: x-w/2, xMax: x+w/2, zMin: z-d/2, zMax: z+d/2, yTop: y+1 };
            scene.add(b);
            platforms.push(b);
        }

        function spawnMob(x, y, z) {
            const g = new THREE.Group();
            const body = new THREE.Mesh(new THREE.BoxGeometry(2, 2, 2), new THREE.MeshStandardMaterial({color: 0xff3300}));
            const eye = new THREE.Mesh(new THREE.BoxGeometry(1.5, 0.5, 0.5), new THREE.MeshBasicMaterial({color: 0x000000}));
            eye.position.set(0, 0.2, 0.8);
            g.add(body, eye);
            g.position.set(x, y, z);
            g.userData = { hp: 1 + Math.floor(vLvl/2), speed: 0.06 + (vLvl*0.01) };
            scene.add(g);
            enemies.push(g);
        }

        function spawnRescue(x, y, z) {
            cage = new THREE.Mesh(new THREE.BoxGeometry(4, 5, 4), new THREE.MeshBasicMaterial({color: 0x00ff00, wireframe: true}));
            cage.position.set(x, y, z);
            
            boobi = new THREE.Mesh(new THREE.SphereGeometry(1, 16, 16), new THREE.MeshStandardMaterial({color: 0xff00ff, roughness: 0}));
            boobi.position.set(x, y, z);
            scene.add(cage, boobi);
        }

        function setupControls() {
            const joy = document.getElementById('joy-base'), knob = document.getElementById('joy-knob');
            
            window.addEventListener('touchstart', e => {
                for(let t of e.changedTouches) {
                    let r = joy.getBoundingClientRect();
                    if(t.clientX > r.left - 20 && t.clientX < r.right + 20 && t.clientY > r.top - 20 && t.clientY < r.bottom + 20) {
                        touches.move = t.identifier;
                    } else if(!touches.look && t.target.className !== 'btn') {
                        touches.look = t.identifier;
                        touches.lx = t.clientX; touches.ly = t.clientY;
                    }
                }
            }, {passive: false});

            window.addEventListener('touchmove', e => {
                // Prevent scroll
                if(e.cancelable) e.preventDefault();
                for(let t of e.changedTouches) {
                    if(t.identifier === touches.move) {
                        let r = joy.getBoundingClientRect();
                        let cx = r.left + 70, cy = r.top + 70;
                        let dx = t.clientX - cx, dy = t.clientY - cy;
                        let dist = Math.min(Math.sqrt(dx*dx+dy*dy), 50);
                        let angle = Math.atan2(dy, dx);
                        knob.style.transform = `translate(${Math.cos(angle)*dist}px, ${Math.sin(angle)*dist}px)`;
                        move.x = Math.cos(angle) * (dist/50); move.y = -Math.sin(angle) * (dist/50);
                    }
                    if(t.identifier === touches.look) {
                        let sens = 0.35;
                        look.x -= (t.clientX - touches.lx) * sens;
                        look.y -= (t.clientY - touches.ly) * sens;
                        touches.lx = t.clientX; touches.ly = t.clientY;
                    }
                }
            }, {passive: false});

            const endTouch = (id) => {
                if(id === touches.move) { touches.move = null; move.x=0; move.y=0; knob.style.transform = `translate(0,0)`; }
                if(id === touches.look) touches.look = null;
            };

            window.addEventListener('touchend', e => { for(let t of e.changedTouches) endTouch(t.identifier); });
            window.addEventListener('touchcancel', e => { for(let t of e.changedTouches) endTouch(t.identifier); });

            document.getElementById('jump-btn').ontouchstart = (e) => { 
                e.preventDefault(); 
                if(jumps < 2) { 
                    velY = 0.4; jumps++; 
                    AudioSys.jump(); 
                } 
            };
            document.getElementById('shoot-btn').ontouchstart = (e) => { 
                e.preventDefault(); 
                fire(); 
            };
        }

        function fire() {
            const now = Date.now();
            if(now - lastShot < 200) return; // Fire rate limit
            lastShot = now;

            AudioSys.shoot();
            gunRecoil = 0.3; // Kickback
            muzzleLight.intensity = 2;

            // Create Bullet
            const b = new THREE.Mesh(new THREE.BoxGeometry(0.1, 0.1, 0.8), new THREE.MeshBasicMaterial({color: 0x00ff00}));
            b.position.set(camera.position.x, camera.position.y - 0.2, camera.position.z);
            
            // Aim vector
            const dir = new THREE.Vector3(0, 0, -1).applyQuaternion(camera.quaternion);
            
            // Slightly offset start so we don't shoot ourselves
            b.position.add(dir.clone().multiplyScalar(1));
            b.lookAt(b.position.clone().add(dir));
            
            b.userData = { v: dir.multiplyScalar(3) };
            scene.add(b); 
            bullets.push(b);
        }

        function animate() {
            requestAnimationFrame(animate);
            if(!isPlaying) return;

            // 1. Camera Rotation
            look.y = Math.max(-85, Math.min(85, look.y));
            const euler = new THREE.Euler(0, 0, 0, 'YXZ');
            euler.x = THREE.MathUtils.degToRad(look.y);
            euler.y = THREE.MathUtils.degToRad(look.x);
            camera.quaternion.setFromEuler(euler);

            // 2. Physics & Movement
            const dt = 1; // Simplify delta
            
            // Calculate Forward/Right vectors relative to player Y rotation
            const fwd = new THREE.Vector3(0, 0, -1).applyAxisAngle(new THREE.Vector3(0,1,0), euler.y);
            const right = new THREE.Vector3(1, 0, 0).applyAxisAngle(new THREE.Vector3(0,1,0), euler.y);
            
            const moveVec = new THREE.Vector3()
                .add(right.multiplyScalar(move.x))
                .add(fwd.multiplyScalar(move.y))
                .normalize()
                .multiplyScalar(0.25); // Move Speed

            camera.position.add(moveVec);

            // Gravity
            velY -= 0.015;
            camera.position.y += velY;

            // Ground Collision
            let onGround = false;
            platforms.forEach(p => {
                const b = p.userData.bounds;
                // Check X/Z overlap
                if(camera.position.x > b.xMin - 0.5 && camera.position.x < b.xMax + 0.5 && 
                   camera.position.z > b.zMin - 0.5 && camera.position.z < b.zMax + 0.5) {
                    
                    // Check Y Landing
                    if(camera.position.y > b.yTop && camera.position.y < b.yTop + 2.5 && velY <= 0) {
                        camera.position.y = b.yTop + 1.2; // Height of player
                        velY = 0; jumps = 0; onGround = true;
                    }
                }
            });

            // Void Death
            if(camera.position.y < -30) { 
                hp -= 30; 
                camera.position.set(0, 10, 0); 
                velY = 0; 
                updateHUD(); 
            }

            // 3. Game Objects Logic
            
            // Gun Animation
            gunRecoil *= 0.8;
            gun.position.z = -0.6 + gunRecoil;
            muzzleLight.intensity *= 0.5;

            // Enemies
            enemies.forEach(e => {
                // Bobbing
                e.children[0].position.y = Math.sin(Date.now()*0.005) * 0.2;
                
                // Chase
                let dist = e.position.distanceTo(camera.position);
                if(dist < 40) {
                    e.lookAt(camera.position.x, e.position.y, camera.position.z);
                    const dir = new THREE.Vector3().subVectors(camera.position, e.position).normalize();
                    dir.y = 0; // Don't fly
                    e.position.add(dir.multiplyScalar(e.userData.speed));
                    
                    if(dist < 2.5) { 
                        hp -= 1; updateHUD(); 
                        // Knockback player slightly
                        camera.position.add(dir.multiplyScalar(0.5));
                    }
                }
            });

            // Bullets
            for(let i = bullets.length - 1; i >= 0; i--) {
                let b = bullets[i];
                b.position.add(b.userData.v);
                
                // Cleanup range
                if(b.position.distanceTo(camera.position) > 100) {
                    scene.remove(b); bullets.splice(i, 1); continue;
                }

                // Hit Detection
                let hit = false;
                for(let j = enemies.length - 1; j >= 0; j--) {
                    let e = enemies[j];
                    if(b.position.distanceTo(e.position) < 2.5) {
                        e.userData.hp--;
                        // Flash red
                        e.children[0].material.color.setHex(0xffffff);
                        setTimeout(() => { if(e) e.children[0].material.color.setHex(0xff3300); }, 50);

                        if(e.userData.hp <= 0) {
                            createExplosion(e.position, 0xff3300);
                            scene.remove(e); enemies.splice(j, 1);
                        }
                        hit = true; break;
                    }
                }
                if(hit) { scene.remove(b); bullets.splice(i, 1); }
            }

            // Particles
            for(let i = particles.length - 1; i >= 0; i--) {
                let p = particles[i];
                p.position.add(p.userData.vel);
                p.userData.vel.y -= 0.02; // Gravity
                p.rotation.x += 0.1; p.rotation.z += 0.1;
                p.userData.life -= 0.03;
                p.scale.setScalar(p.userData.life * 0.3);
                if(p.userData.life <= 0) { scene.remove(p); particles.splice(i, 1); }
            }

            // Win Logic
            if(boobi) {
                boobi.rotation.y += 0.05;
                if(camera.position.distanceTo(boobi.position) < 4) win();
            }

            renderer.render(scene, camera);
        }

        function updateHUD() {
            document.getElementById('hp-val').style.width = Math.max(0, hp) + "%";
            if(hp <= 0) { 
                isPlaying = false;
                alert("GRINDSET BROKEN. RESTARTING."); 
                location.reload(); 
            }
        }

        function win() {
            isPlaying = false;
            AudioSys.win();
            vLvl++;
            document.getElementById('vlvl').innerText = vLvl;
            document.getElementById('win-screen').style.display = 'flex';
            setTimeout(() => {
                document.getElementById('win-screen').style.display = 'none';
                generateLevel();
            }, 3000);
        }

        function onResize() {
            camera.aspect = window.innerWidth/window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
    </script>
</body>
</html>
