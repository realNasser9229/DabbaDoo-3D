<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DABBADOO: VULVIAN DESTINY</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Permanent+Marker&display=swap');

        body { margin: 0; overflow: hidden; background: #000; touch-action: none; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        #landscape-msg { 
            position: fixed; top:0; left:0; width:100%; height:100%; background: #000; color: #0f0; 
            display: none; align-items: center; justify-content: center; z-index: 10000; text-align: center;
            font-family: 'Permanent Marker', cursive; font-size: 24px;
        }
        @media (orientation: portrait) { #landscape-msg { display: flex; } }

        /* HUD Styling */
        #hud { position: absolute; top: 10px; left: 10px; z-index: 100; pointer-events: none; width: 100%; }
        .stat-group { display: flex; gap: 20px; margin-bottom: 10px; }
        .stat { background: rgba(0,255,100,0.1); border-left: 5px solid #0f0; padding: 5px 15px; color: #fff; }
        .stat-label { font-size: 10px; text-transform: uppercase; color: #0f0; display: block; }
        .stat-value { font-size: 20px; font-weight: bold; font-family: 'Permanent Marker'; }
        
        #hp-bar { width: 200px; height: 10px; background: rgba(255,0,0,0.2); border: 1px solid #f00; border-radius: 5px; overflow: hidden; }
        #hp-fill { width: 100%; height: 100%; background: #f00; transition: width 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

        /* Crosshair */
        #crosshair { 
            position: absolute; top: 50%; left: 50%; width: 30px; height: 30px; 
            transform: translate(-50%, -50%); z-index: 50; pointer-events: none; 
        }
        .ch-line { position: absolute; background: #0f0; transition: 0.1s; box-shadow: 0 0 10px #0f0; }
        #ch-v { width: 2px; height: 100%; left: 14px; }
        #ch-h { width: 100%; height: 2px; top: 14px; }

        /* Controls */
        #joy-base { position: absolute; bottom: 40px; left: 40px; width: 120px; height: 120px; background: rgba(255,255,255,0.05); border: 2px solid rgba(0,255,255,0.3); border-radius: 50%; z-index: 100; }
        #joy-knob { position: absolute; top: 35px; left: 35px; width: 50px; height: 50px; background: #0ff; border-radius: 50%; box-shadow: 0 0 20px #0ff; }
        
        .action-btn { position: absolute; z-index: 100; border-radius: 50%; color: #fff; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid #fff; font-family: 'Permanent Marker'; }
        #jump-btn { bottom: 140px; right: 40px; width: 80px; height: 80px; background: rgba(100,0,255,0.5); }
        #fire-btn { bottom: 30px; right: 30px; width: 110px; height: 110px; background: rgba(255,0,50,0.6); font-size: 20px; border-color: #ff0; text-shadow: 0 0 10px #ff0; }

        /* Notifications */
        #msg-overlay { 
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            color: #fff; font-size: 60px; font-family: 'Permanent Marker'; 
            text-align: center; display: none; z-index: 1000; text-shadow: 0 0 30px #f0f;
        }
    </style>
</head>
<body>
    <div id="landscape-msg">ROTATE TO ENTER THE BLOCKVERSE</div>
    
    <div id="hud">
        <div class="stat-group">
            <div class="stat"><span class="stat-label">VULVIAN LEVEL</span><span class="stat-value" id="v-lvl">1</span></div>
            <div class="stat"><span class="stat-label">STAGE</span><span class="stat-value" id="s-lvl">1</span></div>
        </div>
        <div id="hp-bar"><div id="hp-fill"></div></div>
    </div>

    <div id="msg-overlay">THX BRO!</div>
    
    <div id="crosshair">
        <div id="ch-v" class="ch-line"></div>
        <div id="ch-h" class="ch-line"></div>
    </div>

    <div id="joy-base"><div id="joy-knob"></div></div>
    <div id="jump-btn" class="action-btn">ALPHA<br>JUMP</div>
    <div id="fire-btn" class="action-btn">SNOT BOLT</div>

    <script src="https://unpkg.com/three@0.155.0/build/three.min.js"></script>
    <script>
        /** THE VULVIAN ENGINE **/
        let scene, camera, renderer, gun, clock;
        let platforms = [], enemies = [], bullets = [], particles = [];
        let hp = 100, stage = 1, vLvl = 1, gameActive = true, jumps = 0;
        let boobi, cage, targetGoal;

        const SENS = 0.8; 
        let move = { f: 0, r: 0 }, look = { lon: 0, lat: 0 }, velY = 0;
        let tData = { lookId: null, moveId: null, lx: 0, ly: 0 };

        init();
        animate();

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x020005);
            scene.fog = new THREE.FogExp2(0x020005, 0.02);
            clock = new THREE.Clock();
            
            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.body.appendChild(renderer.domElement);

            const hemi = new THREE.HemisphereLight(0x4444ff, 0xff00ff, 0.6);
            const point = new THREE.PointLight(0x00ff00, 1, 100);
            point.position.set(0, 10, 0);
            scene.add(hemi, point);

            createVulvianArm();
            buildWorld();
            setupControls();

            window.addEventListener('resize', onWindowResize);
        }

        function createVulvianArm() {
            gun = new THREE.Group();
            const sleeve = new THREE.Mesh(new THREE.BoxGeometry(0.3, 0.3, 0.8), new THREE.MeshStandardMaterial({color: 0x222222}));
            sleeve.position.set(0.5, -0.4, -0.5);
            
            const barrel = new THREE.Mesh(new THREE.BoxGeometry(0.15, 0.15, 1), new THREE.MeshStandardMaterial({color: 0x00ff00, emissive: 0x00ff00}));
            barrel.position.set(0.5, -0.3, -1);
            
            gun.add(sleeve, barrel);
            camera.add(gun);
            scene.add(camera);
        }

        function buildWorld() {
            // Clean
            platforms.forEach(p => scene.remove(p));
            enemies.forEach(e => scene.remove(e));
            if(cage) scene.remove(cage);
            if(boobi) scene.remove(boobi);
            platforms = []; enemies = []; gameActive = true;

            camera.position.set(0, 5, 0);
            look.lon = 0; look.lat = 0;

            // Start Pad
            spawnPlatform(0, 0, 0, 15, 15, 0x111111, true);

            // Lore Parkour
            let pCount = 5 + (stage * 2);
            let zPos = -15;
            let yPos = 0;

            for(let i=0; i<pCount; i++) {
                let x = (Math.random() - 0.5) * (10 + stage);
                yPos += (Math.random() - 0.2) * 3;
                zPos -= 15 + (stage * 0.5);
                spawnPlatform(x, yPos, zPos, 10, 10, 0x0033ff);
                
                if(i % 2 === 0) spawnBoobasta(x, yPos + 3, zPos);
            }

            // The Rescue Platform
            zPos -= 20;
            spawnPlatform(0, yPos, zPos, 15, 15, 0xff0055, true);
            spawnRescue(0, yPos + 2, zPos);
            targetGoal = new THREE.Vector3(0, yPos + 2, zPos);
        }

        function spawnPlatform(x, y, z, w, d, col, isSafe = false) {
            const mesh = new THREE.Mesh(new THREE.BoxGeometry(w, 2, d), new THREE.MeshStandardMaterial({color: col, emissive: col, emissiveIntensity: 0.1}));
            mesh.position.set(x, y, z);
            mesh.userData.hitbox = { w: w/2 + 0.5, d: d/2 + 0.5 };
            scene.add(mesh);
            platforms.push(mesh);
        }

        function spawnBoobasta(x, y, z) {
            const group = new THREE.Group();
            const body = new THREE.Mesh(new THREE.BoxGeometry(1.5, 2, 1), new THREE.MeshStandardMaterial({color: 0x444444}));
            const eyes = new THREE.Mesh(new THREE.BoxGeometry(1.2, 0.2, 0.1), new THREE.MeshStandardMaterial({color: 0xff0000, emissive: 0xff0000}));
            eyes.position.set(0, 0.5, 0.51);
            group.add(body, eyes);
            group.position.set(x, y, z);
            group.userData = { hp: 2 + stage, speed: 0.04 + (stage * 0.01) };
            scene.add(group);
            enemies.push(group);
        }

        function spawnRescue(x, y, z) {
            cage = new THREE.Mesh(new THREE.BoxGeometry(5, 6, 5), new THREE.MeshStandardMaterial({color: 0xffffff, wireframe: true}));
            cage.position.set(x, y + 1, z);
            boobi = new THREE.Mesh(new THREE.BoxGeometry(1, 1.5, 1), new THREE.MeshStandardMaterial({color: 0xff0000}));
            boobi.position.copy(cage.position);
            scene.add(cage, boobi);
        }

        function setupControls() {
            const joy = document.getElementById('joy-base'), knob = document.getElementById('joy-knob');
            window.ontouchstart = e => {
                for(let t of e.changedTouches) {
                    if (t.clientX > window.innerWidth/2) { tData.lookId = t.identifier; tData.lx = t.clientX; tData.ly = t.clientY; }
                    let r = joy.getBoundingClientRect();
                    if (t.clientX > r.left && t.clientX < r.right && t.clientY > r.top && t.clientY < r.bottom) tData.moveId = t.identifier;
                }
            };
            window.ontouchmove = e => {
                for(let t of e.changedTouches) {
                    if (t.identifier === tData.lookId) {
                        look.lon -= (t.clientX - tData.lx) * SENS;
                        look.lat -= (t.clientY - tData.ly) * SENS;
                        tData.lx = t.clientX; tData.ly = t.clientY;
                    }
                    if (t.identifier === tData.moveId) {
                        let r = joy.getBoundingClientRect(), dx = t.clientX-(r.left+60), dy = t.clientY-(r.top+60);
                        let d = Math.min(Math.sqrt(dx*dx+dy*dy), 50);
                        let a = Math.atan2(dy, dx);
                        knob.style.transform = `translate(${Math.cos(a)*d}px, ${Math.sin(a)*d}px)`;
                        move.f = -Math.sin(a)*(d/50); move.r = Math.cos(a)*(d/50);
                    }
                }
            };
            window.ontouchend = e => {
                for(let t of e.changedTouches) {
                    if (t.identifier === tData.moveId) { move.f = 0; move.r = 0; knob.style.transform = `translate(0,0)`; }
                }
            };
            document.getElementById('fire-btn').ontouchstart = e => { e.preventDefault(); fire(); };
            document.getElementById('jump-btn').ontouchstart = e => { e.preventDefault(); if(jumps < 2) { velY = 0.32; jumps++; } };
        }

        function fire() {
            const b = new THREE.Mesh(new THREE.BoxGeometry(0.2, 0.2, 0.5), new THREE.MeshBasicMaterial({color: 0x00ff00}));
            b.position.copy(camera.position);
            const dir = new THREE.Vector3(0,0,-1).applyQuaternion(camera.quaternion);
            b.userData.v = dir.multiplyScalar(3);
            scene.add(b); bullets.push(b);
            
            gun.position.z += 0.2;
            setTimeout(() => gun.position.z = 0, 100);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            if(!gameActive) return;

            // Rotation
            look.lat = Math.max(-85, Math.min(85, look.lat));
            camera.rotation.order = 'YXZ';
            camera.rotation.y = THREE.MathUtils.degToRad(look.lon);
            camera.rotation.x = THREE.MathUtils.degToRad(look.lat);

            // Movement
            let mDir = new THREE.Vector3(move.r, 0, -move.f).applyQuaternion(new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0,1,0), camera.rotation.y));
            camera.position.add(mDir.multiplyScalar(0.25));

            // Physics & Collisions
            velY -= 0.016;
            camera.position.y += velY;

            let grounded = false;
            platforms.forEach(p => {
                let dx = Math.abs(camera.position.x - p.position.x);
                let dz = Math.abs(camera.position.z - p.position.z);
                if (dx < p.userData.hitbox.w && dz < p.userData.hitbox.d) {
                    if (camera.position.y > p.position.y + 1 && camera.position.y < p.position.y + 3) {
                        camera.position.y = p.position.y + 2;
                        velY = 0; jumps = 0; grounded = true;
                    }
                }
            });

            if(camera.position.y < -30) { 
                hp -= 20; updateHUD(); 
                camera.position.set(0, 10, 0); velY = 0;
            }

            // Enemies Logic
            enemies.forEach(e => {
                let d = e.position.distanceTo(camera.position);
                if(d < 20) {
                    e.lookAt(camera.position.x, e.position.y, camera.position.z);
                    e.position.add(new THREE.Vector3().subVectors(camera.position, e.position).normalize().multiplyScalar(e.userData.speed));
                    if(d < 2.2) { hp -= 0.4; updateHUD(); }
                }
            });

            // Bullets
            for(let i=bullets.length-1; i>=0; i--) {
                bullets[i].position.add(bullets[i].userData.v);
                enemies.forEach((e, j) => {
                    if(bullets[i] && bullets[i].position.distanceTo(e.position) < 2) {
                        e.userData.hp--;
                        scene.remove(bullets[i]); bullets.splice(i,1);
                        if(e.userData.hp <= 0) { scene.remove(e); enemies.splice(j,1); }
                    }
                });
            }

            // Crosshair Reaction
            const ray = new THREE.Raycaster(camera.position, new THREE.Vector3(0,0,-1).applyQuaternion(camera.quaternion));
            const hits = ray.intersectObjects(enemies, true);
            document.getElementById('crosshair').style.filter = hits.length > 0 ? "hue-rotate(90deg) scale(1.5)" : "none";

            // Win Trigger
            if(boobi && camera.position.distanceTo(targetGoal) < 5) {
                victory();
            }

            renderer.render(scene, camera);
        }

        function updateHUD() {
            document.getElementById('hp-fill').style.width = hp + "%";
            if(hp <= 0) { alert("VULVIAN HAS FALLEN. RESTARTING..."); location.reload(); }
        }

        function victory() {
            gameActive = false;
            stage++; vLvl++;
            document.getElementById('v-lvl').innerText = vLvl;
            document.getElementById('s-lvl').innerText = stage;
            
            const msg = document.getElementById('msg-overlay');
            msg.style.display = 'block';
            
            // Dramatic slowdown
            setTimeout(() => {
                msg.style.display = 'none';
                buildWorld();
            }, 2500);
        }
    </script>
</body>
</html>
