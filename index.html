<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>DabbaDoo - 3D FPS Shooter Deluxe</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/0.160.0/three.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root { --game-height: 100dvh; }
        body { margin: 0; padding: 0; overflow: hidden; background: #000; touch-action: none; user-select: none; height: var(--game-height); font-family: 'Press Start 2P', cursive; }
        #gameContainer { position: relative; width: 100%; height: var(--game-height); }
        .pixel-text { font-family: 'Press Start 2P', cursive; image-rendering: pixelated; }
        
        /* RESTORED HUD STYLES */
        #mobileControls { position: absolute; bottom: 40px; left: 0; right: 0; padding: 0 20px; display: flex; justify-content: space-between; align-items: flex-end; pointer-events: none; z-index: 100; }
        .joystick-container { width: 110px; height: 110px; background: rgba(255,255,255,0.1); border-radius: 50%; border: 3px solid rgba(255,255,255,0.3); pointer-events: auto; }
        #joystickStick { width: 45px; height: 45px; background: #ff0000; border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        #shootBtn { width: 85px; height: 85px; background: #dc2626; border-radius: 50%; border: 4px solid #fff; color: white; pointer-events: auto; }
        .hit-marker { position: absolute; width: 30px; height: 30px; border: 2px solid #ff0000; transform: translate(-50%, -50%) rotate(45deg); pointer-events: none; }
    </style>
</head>
<body>

    <div id="gameContainer">
        <div id="hud" class="absolute top-0 left-0 w-full p-4 pointer-events-none z-50">
            <div class="flex justify-between items-start">
                <div class="space-y-2">
                    <div id="hearts" class="flex gap-1 text-lg">❤️❤️❤️❤️❤️</div>
                    <div class="bg-black/80 p-2 border-2 border-red-600 inline-block">
                        <div class="text-white text-[8px] pixel-text">KILLS: <span id="kills" class="text-red-500">0</span></div>
                    </div>
                    <div class="w-32">
                        <div class="text-[6px] text-cyan-400 mb-1 pixel-text">STAMINA</div>
                        <div class="bg-gray-800 h-2 border border-cyan-600">
                            <div id="staminaBar" class="bg-cyan-400 h-full" style="width: 100%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="absolute bottom-32 left-1/2 -translate-x-1/2 z-50 pointer-events-none">
            <div class="bg-black/80 px-4 py-2 border-2 border-yellow-600 text-center">
                <div class="text-[8px] text-yellow-400 pixel-text">AMMO</div>
                <div class="text-white text-xl pixel-text"><span id="ammoCount">30</span>/∞</div>
            </div>
        </div>

        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-10 pointer-events-none">
            <div class="w-6 h-6 border-2 border-white/30 rounded-full flex items-center justify-center">
                <div class="w-1 h-1 bg-red-600"></div>
            </div>
        </div>

        <div id="mobileControls">
            <div id="joyContainer" class="joystick-container"><div id="joystickStick"></div></div>
            <button id="shootBtn" class="pixel-text text-[10px]">FIRE</button>
        </div>

        <div id="startScreen" class="absolute inset-0 bg-black flex flex-col items-center justify-center text-center p-6 z-[1000]">
            <h1 class="text-3xl text-white mb-2 pixel-text">DABBADOO</h1>
            <p class="text-yellow-400 mb-12 text-[8px] pixel-text">RESCUE BOOBI DOODI</p>
            <button id="startBtn" class="bg-red-600 text-white px-10 py-5 border-b-8 border-red-900 pixel-text">START</button>
        </div>
    </div>

<script>
/** ENGINE & SCENE **/
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x050505);
scene.fog = new THREE.FogExp2(0x050505, 0.1);

const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
const renderer = new THREE.WebGLRenderer({ antialias: false });
renderer.setSize(window.innerWidth, window.innerHeight);
document.getElementById('gameContainer').prepend(renderer.domElement);

let gameActive = false;
let player = { pos: new THREE.Vector3(0, 1.6, 0), dir: new THREE.Euler(0, 0, 0, 'YXZ'), health: 5, kills: 0, ammo: 30 };

/** THE GUN MODEL **/
const gunGroup = new THREE.Group();
const gunBody = new THREE.Mesh(new THREE.BoxGeometry(0.2, 0.2, 0.6), new THREE.MeshPhongMaterial({color: 0x333333}));
const gunMuzzle = new THREE.Mesh(new THREE.BoxGeometry(0.1, 0.1, 0.2), new THREE.MeshPhongMaterial({color: 0x111111}));
gunMuzzle.position.z = -0.35;
gunGroup.add(gunBody, gunMuzzle);
gunGroup.position.set(0.3, -0.3, -0.5); // Position gun on right side
camera.add(gunGroup);
scene.add(camera);

/** WORLD **/
scene.add(new THREE.AmbientLight(0xffffff, 0.5));
const pointLight = new THREE.PointLight(0xffffff, 1, 20);
scene.add(pointLight);

const floor = new THREE.Mesh(new THREE.PlaneGeometry(100, 100), new THREE.MeshPhongMaterial({color: 0x111111}));
floor.rotation.x = -Math.PI/2;
scene.add(floor);

/** ENEMIES **/
const enemies = [];
function spawnEnemy() {
    const en = new THREE.Group();
    const body = new THREE.Mesh(new THREE.BoxGeometry(0.8, 1.2, 0.5), new THREE.MeshPhongMaterial({color: 0xff0000}));
    const head = new THREE.Mesh(new THREE.BoxGeometry(0.4, 0.4, 0.4), new THREE.MeshPhongMaterial({color: 0x000000}));
    head.position.y = 0.8;
    en.add(body, head);
    en.position.set(Math.random()*40-20, 0.6, Math.random()*40-20);
    en.userData = { hp: 2 };
    scene.add(en); enemies.push(en);
}
for(let i=0; i<6; i++) spawnEnemy();

/** CONTROLS **/
let lookDelta = { x: 0, y: 0 }, moveDelta = { x: 0, y: 0 }, isTouchingLook = false, lastTouch = { x: 0, y: 0 };

window.addEventListener('touchstart', (e) => {
    const t = e.touches[0];
    if (t.clientX > window.innerWidth / 2) { isTouchingLook = true; lastTouch.x = t.clientX; lastTouch.y = t.clientY; }
});
window.addEventListener('touchmove', (e) => {
    if (!isTouchingLook) return;
    const t = e.touches[0];
    lookDelta.x = (t.clientX - lastTouch.x) * 0.005;
    lookDelta.y = (t.clientY - lastTouch.y) * 0.005;
    lastTouch.x = t.clientX; lastTouch.y = t.clientY;
});
window.addEventListener('touchend', () => isTouchingLook = false);

const joyStick = document.getElementById('joystickStick');
const joyContainer = document.getElementById('joyContainer');
joyContainer.addEventListener('touchmove', (e) => {
    e.preventDefault();
    const t = e.touches[0];
    const rect = joyContainer.getBoundingClientRect();
    const cx = rect.left + rect.width / 2;
    const cy = rect.top + rect.height / 2;
    let dx = t.clientX - cx, dy = t.clientY - cy;
    const dist = Math.min(Math.sqrt(dx*dx + dy*dy), 40);
    const angle = Math.atan2(dy, dx);
    moveDelta.x = Math.cos(angle) * (dist / 40);
    moveDelta.y = Math.sin(angle) * (dist / 40);
    joyStick.style.transform = `translate(calc(-50% + ${Math.cos(angle)*dist}px), calc(-50% + ${Math.sin(angle)*dist}px))`;
});
joyContainer.addEventListener('touchend', () => { moveDelta = { x: 0, y: 0 }; joyStick.style.transform = 'translate(-50%, -50%)'; });

/** SHOOTING **/
function shoot() {
    if(!gameActive || player.ammo <= 0) return;
    player.ammo--;
    document.getElementById('ammoCount').innerText = player.ammo;
    
    // Gun Recoil
    gunGroup.position.z += 0.1;
    setTimeout(() => gunGroup.position.z = -0.5, 50);

    const ray = new THREE.Raycaster();
    ray.setFromCamera({x:0, y:0}, camera);
    const hits = ray.intersectObjects(enemies, true);
    
    if(hits.length > 0) {
        let target = hits[0].object;
        while(target.parent && !enemies.includes(target)) target = target.parent;
        target.userData.hp--;
        if(target.userData.hp <= 0) {
            target.position.set(Math.random()*40-20, 0.6, Math.random()*40-20);
            target.userData.hp = 2;
            player.kills++;
            document.getElementById('kills').innerText = player.kills;
        }
    }
}

function update() {
    if (!gameActive) return;
    player.dir.y -= lookDelta.y; // Fix axis
    player.dir.y -= lookDelta.x;
    player.dir.x -= lookDelta.y;
    player.dir.x = Math.max(-1.4, Math.min(1.4, player.dir.x));
    camera.quaternion.setFromEuler(player.dir);
    lookDelta.x *= 0.5; lookDelta.y *= 0.5;

    const moveVec = new THREE.Vector3(moveDelta.x, 0, moveDelta.y);
    moveVec.applyQuaternion(new THREE.Quaternion().setFromEuler(new THREE.Euler(0, player.dir.y, 0)));
    player.pos.addScaledVector(moveVec, 0.12);
    camera.position.copy(player.pos);
    pointLight.position.copy(player.pos);

    renderer.render(scene, camera);
    requestAnimationFrame(update);
}

document.getElementById('startBtn').onclick = () => {
    document.getElementById('startScreen').style.display = 'none';
    gameActive = true; update();
};
document.getElementById('shootBtn').ontouchstart = (e) => { e.preventDefault(); shoot(); };
</script>
</body>
</html>
