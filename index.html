<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>DabbaDoo - 3D FPS Shooter Deluxe</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/0.160.0/three.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        /* The Secret Sauce for Mobile Scaling */
        :root {
            --game-height: 100dvh;
        }
        body { 
            margin: 0; 
            padding: 0;
            overflow: hidden; 
            background: #000; 
            touch-action: none; 
            user-select: none;
            height: var(--game-height);
            width: 100vw;
        }
        #gameContainer {
            position: relative;
            width: 100%;
            height: var(--game-height);
            overflow: hidden;
        }
        canvas { display: block; }
        .pixel-text { font-family: 'Press Start 2P', cursive; image-rendering: pixelated; }
        
        /* Fixed Control Positioning */
        #mobileControls {
            position: absolute;
            bottom: 40px; /* Lifted up from the very bottom edge */
            left: 0;
            right: 0;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            pointer-events: none;
            z-index: 100;
        }
        .joystick-container { 
            width: 120px; 
            height: 120px; 
            background: rgba(255,255,255,0.15); 
            border-radius: 50%; 
            position: relative; 
            border: 3px solid rgba(255,255,255,0.4); 
            pointer-events: auto;
        }
        #joystickStick { 
            width: 50px; 
            height: 50px; 
            background: #ff0000; 
            border-radius: 50%; 
            position: absolute; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            box-shadow: 0 0 15px rgba(255,0,0,0.5);
        }
        #shootBtn { 
            width: 90px; 
            height: 90px; 
            background: rgba(220, 38, 38, 0.9); 
            border-radius: 50%; 
            border: 4px solid #fff; 
            color: white;
            font-size: 10px;
            pointer-events: auto;
            box-shadow: 0 0 20px rgba(220, 38, 38, 0.6);
        }
        .hit-marker { position: absolute; width: 30px; height: 30px; border: 2px solid #ff4444; transform: translate(-50%, -50%) rotate(45deg); pointer-events: none; z-index: 200; }
    </style>
</head>
<body>

    <div id="gameContainer">
        <div id="hud" class="absolute top-0 left-0 w-full p-4 pointer-events-none z-50">
            <div class="flex justify-between items-start">
                <div class="space-y-2">
                    <div id="hearts" class="flex gap-1 text-xl">❤️❤️❤️❤️❤️</div>
                    <div class="bg-black/80 p-2 border-2 border-red-600 inline-block">
                        <div class="text-white text-[10px] pixel-text">KILLS: <span id="kills" class="text-red-500">0</span></div>
                    </div>
                </div>
                <div class="bg-black/80 p-2 border-2 border-yellow-600">
                    <div class="text-white text-[10px] pixel-text">AMMO: <span id="ammoCount">30</span></div>
                </div>
            </div>
        </div>

        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 pointer-events-none z-10">
            <div class="w-8 h-8 border-2 border-white/30 rounded-full flex items-center justify-center">
                <div class="w-1.5 h-1.5 bg-red-600 rounded-full"></div>
            </div>
        </div>

        <div id="mobileControls">
            <div id="joyContainer" class="joystick-container">
                <div id="joystickStick"></div>
            </div>
            <button id="shootBtn" class="pixel-text active:scale-90 transition-transform">FIRE</button>
        </div>

        <div id="startScreen" class="absolute inset-0 bg-black flex flex-col items-center justify-center text-center p-6 z-[1000]">
            <h1 class="text-3xl text-white mb-2 pixel-text animate-pulse">DABBADOO</h1>
            <p class="text-yellow-400 mb-12 text-[8px] pixel-text">DELUXE MOBILE EDITION</p>
            <button id="startBtn" class="bg-red-600 text-white px-12 py-6 border-b-8 border-red-900 pixel-text hover:bg-red-500 transition-colors">START</button>
        </div>
    </div>

<script>
/** 1. SETUP ENGINE **/
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x0a0a0a);
scene.fog = new THREE.FogExp2(0x0a0a0a, 0.12);

const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
const renderer = new THREE.WebGLRenderer({ antialias: false });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setPixelRatio(window.devicePixelRatio > 1.5 ? 1.5 : 1); // Performance boost
document.getElementById('gameContainer').prepend(renderer.domElement);

let gameActive = false;
let player = { pos: new THREE.Vector3(0, 1.6, 0), dir: new THREE.Euler(0, 0, 0, 'YXZ'), health: 5, kills: 0, ammo: 30 };

/** 2. WORLD LOGIC **/
const floor = new THREE.Mesh(new THREE.PlaneGeometry(100, 100), new THREE.MeshPhongMaterial({ color: 0x151515 }));
floor.rotation.x = -Math.PI / 2;
scene.add(floor);

const walls = [];
for(let i=0; i<25; i++) {
    const wall = new THREE.Mesh(new THREE.BoxGeometry(2, 4, 2), new THREE.MeshPhongMaterial({ color: 0x222222 }));
    wall.position.set(Math.random()*40-20, 2, Math.random()*40-20);
    if(wall.position.length() > 6) { scene.add(wall); walls.push(wall); }
}

scene.add(new THREE.AmbientLight(0xffffff, 0.5));
const pointLight = new THREE.PointLight(0xff0000, 2, 20);
scene.add(pointLight);

/** 3. TOUCH & LOOK CONTROLS **/
let lookDelta = { x: 0, y: 0 }, moveDelta = { x: 0, y: 0 }, isTouchingLook = false, lastTouch = { x: 0, y: 0 };

// Look Logic (Right half of screen)
window.addEventListener('touchstart', (e) => {
    const t = e.touches[0];
    if (t.clientX > window.innerWidth / 2) {
        isTouchingLook = true;
        lastTouch.x = t.clientX; lastTouch.y = t.clientY;
    }
}, { passive: false });

window.addEventListener('touchmove', (e) => {
    if (!isTouchingLook) return;
    const t = e.touches[0];
    lookDelta.x = (t.clientX - lastTouch.x) * 0.006;
    lookDelta.y = (t.clientY - lastTouch.y) * 0.006;
    lastTouch.x = t.clientX; lastTouch.y = t.clientY;
}, { passive: false });

window.addEventListener('touchend', () => isTouchingLook = false);

// Joystick Logic
const joyStick = document.getElementById('joystickStick');
const joyContainer = document.getElementById('joyContainer');
joyContainer.addEventListener('touchmove', (e) => {
    e.preventDefault();
    const t = e.touches[0];
    const rect = joyContainer.getBoundingClientRect();
    const cx = rect.left + rect.width / 2;
    const cy = rect.top + rect.height / 2;
    let dx = t.clientX - cx; let dy = t.clientY - cy;
    const dist = Math.min(Math.sqrt(dx*dx + dy*dy), 50);
    const angle = Math.atan2(dy, dx);
    moveDelta.x = Math.cos(angle) * (dist / 50);
    moveDelta.y = Math.sin(angle) * (dist / 50);
    joyStick.style.transform = `translate(calc(-50% + ${Math.cos(angle)*dist}px), calc(-50% + ${Math.sin(angle)*dist}px))`;
});
joyContainer.addEventListener('touchend', () => {
    moveDelta = { x: 0, y: 0 };
    joyStick.style.transform = 'translate(-50%, -50%)';
});

/** 4. COMBAT **/
const enemies = [];
function spawnEnemy() {
    const en = new THREE.Mesh(new THREE.BoxGeometry(1, 1.8, 1), new THREE.MeshPhongMaterial({ color: 0xff0000 }));
    en.position.set(Math.random()*40-20, 0.9, Math.random()*40-20);
    en.userData = { hp: 2 };
    scene.add(en); enemies.push(en);
}
for(let i=0; i<8; i++) spawnEnemy();

function shoot() {
    if(!gameActive || player.ammo <= 0) return;
    player.ammo--;
    document.getElementById('ammoCount').innerText = player.ammo;
    
    const ray = new THREE.Raycaster();
    ray.setFromCamera({x:0, y:0}, camera);
    const hits = ray.intersectObjects(enemies);
    
    if(hits.length > 0) {
        const target = hits[0].object;
        target.userData.hp--;
        if(target.userData.hp <= 0) {
            target.position.set(Math.random()*40-20, 0.9, Math.random()*40-20);
            target.userData.hp = 2;
            player.kills++;
            document.getElementById('kills').innerText = player.kills;
        }
    }
}

/** 5. FRAME LOOP **/
function update() {
    if (!gameActive) return;

    // Aiming
    player.dir.y -= lookDelta.x;
    player.dir.x -= lookDelta.y;
    player.dir.x = Math.max(-1.4, Math.min(1.4, player.dir.x));
    camera.quaternion.setFromEuler(player.dir);
    lookDelta.x *= 0.5; lookDelta.y *= 0.5;

    // Moving
    const moveVec = new THREE.Vector3(moveDelta.x, 0, moveDelta.y);
    moveVec.applyQuaternion(new THREE.Quaternion().setFromEuler(new THREE.Euler(0, player.dir.y, 0)));
    
    // Wall Collision
    const nextPos = player.pos.clone().addScaledVector(moveVec, 0.15);
    let canMove = true;
    walls.forEach(w => { if (nextPos.distanceTo(w.position) < 1.6) canMove = false; });
    if(canMove) player.pos.copy(nextPos);

    camera.position.copy(player.pos);
    pointLight.position.copy(player.pos);

    renderer.render(scene, camera);
    requestAnimationFrame(update);
}

document.getElementById('startBtn').onclick = () => {
    document.getElementById('startScreen').style.display = 'none';
    gameActive = true;
    update();
};

document.getElementById('shootBtn').ontouchstart = (e) => { e.preventDefault(); shoot(); };
window.addEventListener('resize', () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
});
</script>
</body>
</html>
