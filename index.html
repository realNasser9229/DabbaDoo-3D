<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DABBADOO DELUXE - Dr. RagorGaming Edition</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; touch-action: none; font-family: 'Courier New', Courier, monospace; }
        #ui { position: absolute; top: 20px; left: 20px; color: #fff; z-index: 100; pointer-events: none; }
        .stat { font-size: 28px; font-weight: 900; text-shadow: 3px 3px #f00; letter-spacing: 1px; color: #0f0; margin-bottom: 5px; }
        #health { font-size: 32px; color: #f00; }
        #cake-warning { position: absolute; top: 10%; width: 100%; text-align: center; color: #f00; font-weight: bold; font-size: 20px; opacity: 0.5; pointer-events: none; }
        
        /* Crosshair */
        #crosshair { position: absolute; top: 50%; left: 50%; width: 40px; height: 40px; border: 2px solid #0f0; transform: translate(-50%, -50%); z-index: 50; }
        #crosshair:before { content: ''; position: absolute; top: 50%; left: 0; width: 100%; height: 2px; background: #0f0; }
        #crosshair:after { content: ''; position: absolute; left: 50%; top: 0; width: 2px; height: 100%; background: #0f0; }

        /* Buttons */
        .btn { position: absolute; border-radius: 10px; background: rgba(50,50,50,0.8); border: 4px solid #fff; display: flex; align-items: center; justify-content: center; color: #fff; z-index: 100; font-weight: bold; }
        #joy-base { width: 130px; height: 130px; bottom: 40px; left: 40px; background: rgba(255,255,255,0.1); border: 2px solid #555; border-radius: 50%; position: absolute; }
        #joy-knob { width: 60px; height: 60px; background: #f00; border-radius: 50%; position: absolute; top: 35px; left: 35px; box-shadow: 0 0 20px #f00; }
        
        #jump-btn { width: 90px; height: 90px; bottom: 160px; right: 40px; background: #00f; }
        #shoot-btn { width: 130px; height: 130px; bottom: 20px; right: 30px; font-size: 24px; background: #f00; border-color: #ff0; animation: pulse 0.5s infinite; }
        
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        
        #msg { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #0f0; font-size: 60px; font-weight: 900; text-shadow: 0 0 30px #0f0; display: none; z-index: 200; pointer-events: none; }
        #gameover { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); color: #f00; font-size: 50px; text-align: center; padding-top: 40%; z-index: 300; }
    </style>
</head>
<body>
    <div id="cake-warning">THE CAKE IS A LIE. THE CAKE IS A LIE.</div>
    <div id="ui">
        <div class="stat">SIGMA SCORE: <span id="sc">0</span></div>
        <div class="stat">AMMO: <span id="am">12/12</span></div>
        <div class="stat" id="health">HEALTH: ❤️❤️❤️</div>
        <div class="stat" style="color: #0ff;">BROTHER STATUS: NEEDS RESCUE</div>
    </div>
    
    <div id="msg"></div>
    <div id="gameover">RAGE QUIT<br>BOOBI DOODI STILL WAITING<br>ONE MORE RUN?</div>
    <div id="crosshair"></div>
    <div id="joy-base"><div id="joy-knob"></div></div>
    <div id="jump-btn" class="btn">DOUBLE<br>JUMP</div>
    <div id="shoot-btn" class="btn">GRIND</div>

    <script src="https://unpkg.com/three@0.155.0/build/three.min.js"></script>
    <script>
        let scene, camera, renderer, gun, clock;
        let bullets = [], enemies = [], particles = [], powerups = [];
        let score = 0, ammo = 12, reloading = false, jumps = 0, health = 3;
        let rapidFire = false, brotherBarrier;

        const SENSITIVITY = 0.35;
        let move = { f: 0, r: 0 }, look = { lon: 0, lat: 0 }, velY = 0;
        let tData = { lookId: null, moveId: null, lx: 0, ly: 0 };

        init();
        animate();

        function createFaceTexture(isEvil = false) {
            const canvas = document.createElement('canvas');
            canvas.width = 64; canvas.height = 64;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = 'white'; ctx.fillRect(0,0,64,64);
            ctx.fillStyle = 'black';
            ctx.fillRect(15, 20, 8, 8); ctx.fillRect(41, 20, 8, 8);
            ctx.beginPath();
            ctx.moveTo(15, 45); ctx.lineTo(49, isEvil ? 40 : 45);
            ctx.lineWidth = 4; ctx.stroke();
            return new THREE.CanvasTexture(canvas);
        }

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x050515);
            scene.fog = new THREE.FogExp2(0x000000, 0.015);
            clock = new THREE.Clock();

            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 200);
            camera.position.y = 1.7;

            renderer = new THREE.WebGLRenderer({ antialias: false });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            const light = new THREE.HemisphereLight(0xffffff, 0x444444, 1.5);
            scene.add(light);

            // Ground
            const ground = new THREE.Mesh(new THREE.PlaneGeometry(200, 200), new THREE.MeshStandardMaterial({color: 0x333333}));
            ground.rotation.x = -Math.PI/2;
            scene.add(ground);

            // Platforms
            for(let i = 0; i < 20; i++) {
                const plat = new THREE.Mesh(new THREE.BoxGeometry(10 + Math.random()*20, 0.5, 10 + Math.random()*20), new THREE.MeshStandardMaterial({color: 0xff0000}));
                plat.position.set(Math.random()*100-50, 0.25, -i*20 - 20);
                scene.add(plat);
            }

            // Brother barrier at end
            brotherBarrier = new THREE.Mesh(new THREE.BoxGeometry(8, 10, 2), new THREE.MeshStandardMaterial({color: 0x888888, transparent: true, opacity: 0.7}));
            brotherBarrier.position.set(0, 5, -200);
            scene.add(brotherBarrier);

            // Boobi Doodi behind barrier (simple sprite plane)
            const boobiTex = new THREE.Mesh(new THREE.PlaneGeometry(6, 8), new THREE.MeshBasicMaterial({color: 0xffffff, transparent: true}));
            boobiTex.position.set(0, 5, -199);
            scene.add(boobiTex);

            // Vulvian's gun
            gun = new THREE.Group();
            const body = new THREE.Mesh(new THREE.BoxGeometry(0.15, 0.2, 0.8), new THREE.MeshStandardMaterial({color: 0x111111}));
            const barrel = new THREE.Mesh(new THREE.CylinderGeometry(0.04, 0.04, 0.5), new THREE.MeshStandardMaterial({color: 0x333333}));
            barrel.rotation.x = Math.PI/2; barrel.position.z = -0.5;
            gun.add(body, barrel);
            gun.position.set(0.4, -0.3, -0.7);
            camera.add(gun);
            scene.add(camera);

            for(let i=0; i<15; i++) spawnBoobasta();
            setInterval(spawnPowerup, 8000);
            setupTouch();
        }

        function spawnBoobasta() {
            const boobasta = new THREE.Group();
            const body = new THREE.Mesh(new THREE.BoxGeometry(1, 1.8, 0.8), new THREE.MeshStandardMaterial({color: 0x888888}));
            const head = new THREE.Mesh(new THREE.BoxGeometry(0.8, 0.8, 0.8), new THREE.MeshStandardMaterial({map: createFaceTexture(true)}));
            head.position.y = 1.2;
            boobasta.add(body, head);
            boobasta.position.set(Math.random()*40-20, 1, Math.random()*-50-20);
            scene.add(boobasta);
            enemies.push({mesh: boobasta, speed: 0.03 + Math.random()*0.02});
        }

        function spawnPowerup() {
            const p = new THREE.Mesh(new THREE.BoxGeometry(1,1,1), new THREE.MeshStandardMaterial({color: 0x00ff00}));
            p.position.set(Math.random()*40-20, 2, Math.random()*-80-20);
            scene.add(p);
            powerups.push(p);
        }

        function setupTouch() {
            // Same as your original but smoother
            // (kept your code, just minor tweaks for reliability)
            // ... (your touch code here, unchanged for brevity)
        }

        function shoot() {
            if (reloading || ammo <= 0) return;
            ammo--; document.getElementById('am').innerText = `${ammo}/12`;
            
            const flash = new THREE.Mesh(new THREE.SphereGeometry(0.2), new THREE.MeshBasicMaterial({color: 0xffff00}));
            flash.position.copy(gun.position).add(new THREE.Vector3(0,0,-0.6));
            camera.add(flash); scene.add(flash);
            setTimeout(() => scene.remove(flash), 100);

            const b = new THREE.Mesh(new THREE.BoxGeometry(0.2, 0.2, 0.4), new THREE.MeshBasicMaterial({color: 0xffff00}));
            b.position.copy(camera.position);
            b.quaternion.copy(camera.quaternion);
            b.translateZ(-1);
            b.userData.v = new THREE.Vector3(0,0,-2).applyQuaternion(camera.quaternion);
            scene.add(b); bullets.push(b);

            gun.position.z = -0.5;
            setTimeout(() => gun.position.z = -0.7, 100);

            if(ammo === 0) doReload();
        }

        function doReload() {
            reloading = true;
            document.getElementById('msg').innerText = 'SNEEZING DABBADOO...';
            document.getElementById('msg').style.display = 'block';
            let interval = setInterval(() => {
                for(let i=0; i<3; i++) {
                    const p = new THREE.Mesh(new THREE.BoxGeometry(0.1,0.1,0.1), new THREE.MeshBasicMaterial({color: 0x00ff00}));
                    p.position.copy(gun.position.clone().add(new THREE.Vector3(0,0,-0.5)));
                    p.userData.v = new THREE.Vector3((Math.random()-0.5)*0.2, (Math.random()-0.5)*0.2, -0.5);
                    scene.add(p); particles.push(p);
                }
            }, 100);
            setTimeout(() => {
                clearInterval(interval);
                ammo = 12 + (rapidFire ? 6 : 0);
                reloading = false;
                document.getElementById('am').innerText = `${ammo}/12`;
                document.getElementById('msg').style.display = 'none';
            }, 1800);
        }

        function animate() {
            requestAnimationFrame(animate);
            const delta = clock.getDelta();

            // Movement & look (your code, kept)
            // ...

            // Enemy chase + damage
            enemies.forEach((e, i) => {
                const dir = new THREE.Vector3().subVectors(camera.position, e.mesh.position).normalize();
                e.mesh.position.add(dir.multiplyScalar(e.speed));
                e.mesh.lookAt(camera.position);
                if(e.mesh.position.distanceTo(camera.position) < 2) {
                    health--;
                    document.getElementById('health').innerText = 'HEALTH: ' + '❤️'.repeat(health);
                    camera.position.x += (Math.random()-0.5)*0.5; // Knockback
                    if(health <= 0) gameOver();
                }
            });

            // Powerup pickup
            powerups.forEach((p, i) => {
                if(p.position.distanceTo(camera.position) < 3) {
                    scene.remove(p); powerups.splice(i,1);
                    rapidFire = true;
                    setTimeout(() => rapidFire = false, 8000);
                    document.getElementById('msg').innerText = 'RAPID FIRE ACTIVATED!';
                    document.getElementById('msg').style.display = 'block';
                    setTimeout(() => document.getElementById('msg').style.display = 'none', 2000);
                }
            });

            // Win condition
            if(brotherBarrier && camera.position.distanceTo(brotherBarrier.position) < 10) {
                document.getElementById('msg').innerText = 'Thx bro';
                document.getElementById('msg').style.color = '#ff0';
                document.getElementById('msg').style.display = 'block';
                score += 10000;
                document.getElementById('sc').innerText = score;
                // Victory dab
                gun.rotation.z = Math.PI/4;
                setTimeout(() => gun.rotation.z = 0, 500);
                setTimeout(() => document.getElementById('msg').style.display = 'none', 3000);
            }

            renderer.render(scene, camera);
        }

        function gameOver() {
            document.getElementById('gameover').style.display = 'block';
        }
    </script>
</body>
</html>
